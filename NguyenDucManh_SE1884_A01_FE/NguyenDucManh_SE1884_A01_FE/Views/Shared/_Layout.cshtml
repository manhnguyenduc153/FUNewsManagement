@using Frontend.Services
@inject IJwtHelperService JwtHelper

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"] - FUNews</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">


    <link rel="stylesheet" href="~/css/site.css" />
</head>
<body>

    <div class="layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-title">FUNews</div>

            <nav class="sidebar-nav">
                <a href="/PublicNews" class="nav-link">
                    Public News
                </a>
                <hr class="sidebar-divider my-2">
                
                @{
                    var userInfo = JwtHelper.GetUserInfo();
                    var isLoggedIn = userInfo.IsAuthenticated;
                    var userName = userInfo.UserName;
                    var userEmail = userInfo.Email;
                    var userRole = userInfo.Role;
                }

                @if (isLoggedIn)
                {
                    <div class="sidebar-subtitle">Management</div>
                    
                    @if (userRole == "Admin")
                    {
                        <a href="/Dashboard" class="nav-link">
                            Dashboard
                        </a>
                        <a href="/Dashboard/Trending" class="nav-link">
                            Trending Articles
                        </a>
                        <a href="/SystemAccount" class="nav-link">
                            System Accounts
                        </a>
                        <a href="/NewsArticle" class="nav-link">
                            News Articles
                        </a>
                        <a href="/Category" class="nav-link">
                            Categories
                        </a>
                        <a href="/Tag" class="nav-link">
                            Tags
                        </a>
                        <a href="/Report" class="nav-link">
                            Reports
                        </a>
                        <a href="/AuditLog" class="nav-link">
                            Audit Log
                        </a>
                    }
                    
                    @if (userRole == "Staff")
                    {
                        <a href="/NewsArticle/MyArticles" class="nav-link">
                            My Articles
                        </a>
                        <a href="/Category" class="nav-link">
                            Categories
                        </a>
                        <a href="/Tag" class="nav-link">
                            Tags
                        </a>
                    }
                    
                    <hr class="sidebar-divider my-2">
                    <div class="sidebar-user-info">
                        <div class="user-name">
                            @userName
                        </div>
                        <div class="user-email">
                            @userEmail
                        </div>
                    </div>
                    <a href="/Login/Logout" class="nav-link text-danger">
                        Logout
                    </a>
                }
                else
                {
                    <a href="/Login" class="nav-link btn btn-primary w-100">
                        Login
                    </a>
                }
            </nav>
        </aside>

        <!-- CONTENT -->
        <main class="content">
            <!-- Offline Banner -->
            <div id="offlineBanner" class="alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; display: none; width: 90%; max-width: 600px;" role="alert">
                <i class="bi bi-wifi-off"></i> <strong>Offline Mode</strong> - API is unreachable. Displaying cached data. CRUD operations are disabled.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            @if (isLoggedIn)
            {
                <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
                    <div class="dropdown">
                        <button class="btn btn-light position-relative" type="button" id="notificationDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationCount" style="display:none;">0</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" style="width: 300px; max-height: 400px; overflow-y: auto;" id="notificationList">
                            <li><h6 class="dropdown-header">Notifications</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="text-center text-muted p-3">No notifications</li>
                        </ul>
                    </div>
                </div>
            }
            @RenderBody()
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>

    @if (isLoggedIn)
    {
        <script>
            const notifications = [];
            const accessToken = '@Html.Raw(Context.Session.GetString("AccessToken"))';
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("https://localhost:7053/notificationHub")
                .build();

            connection.on("ReceiveNotification", function (message) {
                loadNotifications();
                showToast(message);
            });

            connection.start().then(() => {
                console.log('SignalR Connected');
                loadNotifications();
            }).catch(err => console.error('SignalR Error:', err));

            function loadNotifications() {
                fetch('https://localhost:7053/api/notification/recent', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                })
                .then(res => res.json())
                .then(data => {
                    notifications.length = 0;
                    data.forEach(n => {
                        notifications.push({ id: n.id, message: n.message, time: new Date(n.createdAt), isRead: n.isRead });
                    });
                    updateNotificationUI();
                })
                .catch(err => console.error('Load notifications error:', err));
            }

            function updateNotificationUI() {
                const unreadCount = notifications.filter(n => !n.isRead).length;
                $('#notificationCount').text(unreadCount).toggle(unreadCount > 0);
                
                let html = '<li><h6 class="dropdown-header">Notifications</h6></li>';
                html += '<li><button class="dropdown-item text-primary" onclick="markAllAsRead()"><i class="bi bi-check-all"></i> Mark all as read</button></li>';
                html += '<li><hr class="dropdown-divider"></li>';
                
                if (notifications.length === 0) {
                    html += '<li class="text-center text-muted p-3">No notifications</li>';
                } else {
                    notifications.forEach(n => {
                        const bgClass = n.isRead ? '' : 'bg-light';
                        html += `<li><a class="dropdown-item ${bgClass}" href="#" onclick="markAsRead(${n.id})">${n.message}<br><small class="text-muted">${n.time.toLocaleTimeString()}</small></a></li>`;
                    });
                }
                $('#notificationList').html(html);
            }

            function markAsRead(id) {
                fetch(`https://localhost:7053/api/notification/${id}/read`, {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                })
                .then(() => {
                    const notification = notifications.find(n => n.id === id);
                    if (notification) notification.isRead = true;
                    updateNotificationUI();
                })
                .catch(err => console.error('Mark as read error:', err));
            }

            function markAllAsRead() {
                fetch('https://localhost:7053/api/notification/read-all', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                })
                .then(() => {
                    notifications.forEach(n => n.isRead = true);
                    updateNotificationUI();
                })
                .catch(err => console.error('Mark all as read error:', err));
            }

            function showToast(message) {
                const toast = `<div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div class="toast align-items-center text-bg-info border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                </div>`;
                $('body').append(toast);
                new bootstrap.Toast($('.toast').last()[0], {delay: 5000}).show();
            }
        </script>
    }

    <script>
        $(document).ready(function() {
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                var toast = `<div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">@TempData["SuccessMessage"]</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                </div>`;
                $('body').append(toast);
                var toastEl = $('.toast').last()[0];
                new bootstrap.Toast(toastEl, {delay: 3000}).show();
                </text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                var toast = `<div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">@TempData["ErrorMessage"]</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                </div>`;
                $('body').append(toast);
                var toastEl = $('.toast').last()[0];
                new bootstrap.Toast(toastEl, {delay: 3000}).show();
                </text>
            }
        });
    </script>

    @RenderSection("Scripts", required: false)

    <script>
        // Offline Mode Detection with Page Caching
        let isOfflineMode = false;
        const CACHE_KEY_PREFIX = 'funews_page_';
        const CACHE_EXPIRY = 3600000; // 1 hour
        
        // Cache current page HTML
        function cacheCurrentPage() {
            try {
                const pageKey = window.location.pathname;
                const cacheItem = {
                    html: document.documentElement.outerHTML,
                    timestamp: Date.now()
                };
                localStorage.setItem(CACHE_KEY_PREFIX + pageKey, JSON.stringify(cacheItem));
                console.log('[Cache] Saved page:', pageKey);
            } catch (e) {
                console.error('Cache page error:', e);
            }
        }
        
        // Get cached page HTML
        function getCachedPage(pageKey) {
            try {
                const cached = localStorage.getItem(CACHE_KEY_PREFIX + pageKey);
                if (!cached) return null;
                
                const cacheItem = JSON.parse(cached);
                if (Date.now() - cacheItem.timestamp > CACHE_EXPIRY) {
                    localStorage.removeItem(CACHE_KEY_PREFIX + pageKey);
                    return null;
                }
                
                return cacheItem.html;
            } catch (e) {
                return null;
            }
        }
        
        // Intercept jQuery AJAX for dynamic content
        $(document).ajaxSuccess(function(event, xhr, settings) {
            if (settings.type === 'GET') {
                try {
                    const data = xhr.responseText;
                    localStorage.setItem(CACHE_KEY_PREFIX + settings.url, JSON.stringify({
                        data: data,
                        timestamp: Date.now()
                    }));
                    console.log('[Cache] Saved AJAX:', settings.url);
                } catch (e) {}
            }
        });
        
        $(document).ajaxError(function(event, xhr, settings) {
            if (isOfflineMode && settings.type === 'GET') {
                try {
                    const cached = localStorage.getItem(CACHE_KEY_PREFIX + settings.url);
                    if (cached) {
                        const cacheItem = JSON.parse(cached);
                        if (Date.now() - cacheItem.timestamp < CACHE_EXPIRY) {
                            console.log('[Cache] Using cached AJAX for:', settings.url);
                            if (settings.success) {
                                settings.success(cacheItem.data);
                            }
                        }
                    }
                } catch (e) {}
            }
        });
        
        async function checkApiConnectivity() {
            try {
                const response = await fetch('https://localhost:7053/api/tags/all', {
                    method: 'GET',
                    headers: { 'Authorization': 'Bearer ' + '@Html.Raw(Context.Session.GetString("AccessToken"))' },
                    signal: AbortSignal.timeout(5000)
                });
                
                setOfflineMode(!response.ok);
            } catch (error) {
                setOfflineMode(true);
            }
        }
        
        function setOfflineMode(offline) {
            const wasOffline = isOfflineMode;
            isOfflineMode = offline;
            const banner = document.getElementById('offlineBanner');
            
            if (offline) {
                banner.style.display = 'block';
                console.log('[Offline Mode] Enabled - Page cached, CRUD disabled');
                
                // Disable all CRUD buttons
                document.querySelectorAll('button[type="submit"], .btn-primary:not(.btn-close), .btn-danger, .btn-warning').forEach(btn => {
                    if (!btn.id.includes('notification') && !btn.classList.contains('btn-close')) {
                        btn.disabled = true;
                        btn.title = 'Disabled in offline mode';
                    }
                });
                
                // Prevent form submissions
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', function(e) {
                        if (isOfflineMode) {
                            e.preventDefault();
                            alert('CRUD operations are disabled in offline mode');
                        }
                    });
                });
                
                // Disable links that would navigate away
                document.querySelectorAll('a[href^="/"]').forEach(link => {
                    link.addEventListener('click', function(e) {
                        const href = this.getAttribute('href');
                        const cachedPage = getCachedPage(href);
                        if (!cachedPage) {
                            e.preventDefault();
                            alert('This page is not available offline. Please reconnect to the internet.');
                        }
                    });
                });
            } else {
                banner.style.display = 'none';
                if (wasOffline) {
                    console.log('[Online Mode] Enabled');
                }
                
                // Re-enable buttons
                document.querySelectorAll('button[type="submit"], .btn-primary, .btn-danger, .btn-warning').forEach(btn => {
                    btn.disabled = false;
                    btn.title = '';
                });
            }
        }
        
        // Cache page on load (when online)
        window.addEventListener('load', () => {
            checkApiConnectivity().then(() => {
                if (!isOfflineMode) {
                    cacheCurrentPage();
                }
            });
            
            // Check every 30 seconds
            setInterval(checkApiConnectivity, 30000);
        });
        
        // Check when online/offline events fire
        window.addEventListener('online', () => checkApiConnectivity());
        window.addEventListener('offline', () => setOfflineMode(true));
    </script>

</body>
</html>
