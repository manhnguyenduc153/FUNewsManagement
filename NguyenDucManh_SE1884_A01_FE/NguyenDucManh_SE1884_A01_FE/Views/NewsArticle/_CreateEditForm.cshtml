@model Assignmen_PRN232__.Dto.NewsArticleSaveDto
@using Assignmen_PRN232__.Dto
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    var categories = (List<CategoryDto>?)ViewBag.Categories ?? new List<CategoryDto>();
    var accessToken = HttpContextAccessor.HttpContext?.Session.GetString("AccessToken") ?? "";
}

<!-- NewsArticleId (hidden) -->
<input type="hidden" name="NewsArticleId" value="@Model.NewsArticleId" />
<input type="hidden" name="CreatedById" value="@Model.CreatedById" />
<input type="hidden" name="UpdatedById" value="@Model.UpdatedById" />
<input type="hidden" name="CreatedDate" value="@Model.CreatedDate" />
<input type="hidden" name="ModifiedDate" value="@Model.ModifiedDate" />
<input type="hidden" id="imageUrlHidden" name="ImageUrl" value="@Model.ImageUrl" />

<div class="modal-body">
    <!-- News Title -->
    <div class="mb-3">
        <label for="newsTitle" class="form-label">News Title <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="newsTitle" name="NewsTitle" 
               value="@Model.NewsTitle" required 
               placeholder="Enter news title">
        <small class="form-text text-muted">e.g., Breaking News, Special Report</small>
    </div>

    <!-- Headline -->
    <div class="mb-3">
        <label for="headline" class="form-label">Headline <span class="text-danger">*</span></label>
        <input type="text" class="form-control" id="headline" name="Headline" 
               value="@Model.Headline" required 
               placeholder="Enter headline">
        <small class="form-text text-muted">Main headline of the article</small>
    </div>

    <!-- News Content -->
    <div class="mb-3">
        <label for="newsContent" class="form-label">News Content</label>
        <textarea class="form-control" id="newsContent" name="NewsContent" rows="5" 
                  placeholder="Enter news content">@Model.NewsContent</textarea>
    </div>

    <!-- News Source -->
    <div class="mb-3">
        <label for="newsSource" class="form-label">News Source</label>
        <input type="text" class="form-control" id="newsSource" name="NewsSource" 
               value="@Model.NewsSource" 
               placeholder="Enter news source">
    </div>

    <!-- Image Upload -->
    <div class="mb-3">
        <label for="imageFile" class="form-label">Article Image</label>
        <input type="file" class="form-control" id="imageFile" accept=".jpg,.jpeg,.png,.gif,.webp">
        <small class="form-text text-muted">Max 5MB. Formats: jpg, jpeg, png, gif, webp</small>
        <div id="imagePreview" class="mt-2">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@($"https://localhost:7053{Model.ImageUrl}")" alt="Preview" style="max-width: 200px; max-height: 200px;" class="img-thumbnail">
                <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeImage()">Remove</button>
            }
        </div>
    </div>

    <!-- Category -->
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="categoryId" class="form-label">Category</label>
                <select class="form-select" id="categoryId" name="CategoryId">
                    <option value="">Select Category</option>
                    @foreach (var cat in categories)
                    {
                        <option value="@cat.CategoryId" selected="@(Model.CategoryId == cat.CategoryId)">@cat.CategoryName</option>
                    }
                </select>
            </div>
        </div>

        <!-- Status -->
        <div class="col-md-6">
            <div class="mb-3">
                <label for="newsStatus" class="form-label">Status</label>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="newsStatus" 
                           @(Model.NewsStatus == true ? "checked" : "")>
                    <input type="hidden" id="newsStatusHidden" name="NewsStatus" value="@(Model.NewsStatus == true ? "true" : "false")" />
                    <label class="form-check-label" for="newsStatus">
                        Active
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
    <button type="submit" class="btn btn-primary" form="newsArticleForm">
        <i class="bi bi-save"></i> @(string.IsNullOrEmpty(Model.NewsArticleId) ? "Create" : "Update")
    </button>
</div>

<script>
    // Đồng bộ checkbox với hidden input
    document.getElementById('newsStatus').addEventListener('change', function() {
        document.getElementById('newsStatusHidden').value = this.checked ? 'true' : 'false';
    });

    // Image upload preview
    document.getElementById('imageFile').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file size
        if (file.size > 5 * 1024 * 1024) {
            alert('File size exceeds 5MB limit');
            e.target.value = '';
            return;
        }

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('Invalid file format. Only jpg, jpeg, png, gif, webp are allowed');
            e.target.value = '';
            return;
        }

        // Upload to server
        const formData = new FormData();
        formData.append('file', file);

        try {
            const token = '@accessToken';
            const response = await fetch('https://localhost:7053/api/fileupload/image', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token
                },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                document.getElementById('imageUrlHidden').value = data.imageUrl;
                
                // Show preview
                document.getElementById('imagePreview').innerHTML = `
                    <img src="https://localhost:7053${data.imageUrl}" alt="Preview" style="max-width: 200px; max-height: 200px;" class="img-thumbnail">
                    <button type="button" class="btn btn-sm btn-danger ms-2" onclick="removeImage()">Remove</button>
                `;
            } else {
                const error = await response.json();
                alert(error.message || 'Upload failed');
            }
        } catch (error) {
            alert('Error uploading image');
        }
    });

    function removeImage() {
        document.getElementById('imageFile').value = '';
        document.getElementById('imageUrlHidden').value = '';
        document.getElementById('imagePreview').innerHTML = '';
    }
</script>
